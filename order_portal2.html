<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Portal - Remote Roofers</title>

<link rel="stylesheet" href="styles1.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Minimal inline styles for deploy-ready look */
body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f9f9f9; }
.navbar { background:#1e40af; color:#fff; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; }
.navbar a, .navbar button { color:#fff; margin-left:10px; text-decoration:none; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
.navbar button { background:#ef4444; }
.portal-container { max-width:600px; margin:30px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.form-group { margin-bottom:16px; }
select, textarea { width:100%; padding:8px; border-radius:4px; border:1px solid #ccc; }
.btn-primary { background:#1e40af; color:#fff; border:none; padding:10px 16px; border-radius:4px; cursor:pointer; }
.btn-primary:hover { background:#2563eb; }
.error-message { color:#ef4444; margin-top:8px; }
.pricing-card { background:#f3f4f6; padding:12px; border-radius:4px; margin-bottom:16px; }
</style>
</head>
<body>

<nav class="navbar">
  <h2>Remote Roofers</h2>
  <div>
    <a href="client_portal.html">Back to Portal</a>
    <button onclick="logout()">Logout</button>
  </div>
</nav>

<div class="portal-container">
  <h1>Create New Order</h1>
  <p>Select your report type and service level</p>

  <form id="orderForm">

    <div class="form-group">
      <label>Report Type</label>
      <select id="reportType" required onchange="updatePricing()">
        <option value="">Select report type</option>
        <option value="Aerial Square Roof Report">Aerial Square Roof Report</option>
        <option value="Residential Roof Report">Residential Roof Report</option>
        <option value="Commercial Roof Report">Commercial Roof Report</option>
      </select>
    </div>

    <div class="form-group">
      <label>Service Tier</label>
      <select id="serviceTier" required onchange="updatePricing()">
        <option value="">Select service tier</option>
        <option value="Standard">Standard (≤ 8 hrs)</option>
        <option value="Express">Express (≤ 6 hrs)</option>
        <option value="Rush">Rush (2–3 hrs)</option>
      </select>
    </div>

    <div class="pricing-card">
      <h3>Order Summary</h3>
      <p>Report: <strong id="selectedReport">-</strong></p>
      <p>Tier: <strong id="selectedTier">-</strong></p>
      <p>Total: <strong id="totalPrice">$0</strong></p>
    </div>

    <div class="form-group">
      <label>Additional Notes</label>
      <textarea id="orderNotes" rows="4" placeholder="Any special instructions..."></textarea>
    </div>

    <!-- Simulation Button -->
    <button type="button" id="submitOrderBtn" class="btn-primary" style="display:none;">Submit Order (Simulation)</button>

    <!-- PayPal Button -->
    <div id="paypalButtonContainer" style="display:none; margin-top:16px;"></div>

    <p id="orderError" class="error-message"></p>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- PayPal -->
<script src="https://www.paypal.com/sdk/js?client-id=ARiAdLTougjptHbODwbDVmc3ehO6osM9KmmGZLJaVHoSOXCOsjo56lVHx8hi78_HdZq5zkjE4DQSgOLQ&currency=USD"></script>

<script>
/* =============================
   CONFIG: Toggle Mode
============================= */
const PAYMENT_MODE = "simulation"; // "simulation" or "live"

/* Firebase Init */
firebase.initializeApp({
  apiKey: "AIzaSyDmBLEUz5EWtv1si_UgfKgOiRS8P-wWOnc",
  authDomain: "remoteroofers-51826.firebaseapp.com",
  projectId: "remoteroofers-51826"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* Auth Guard */
auth.onAuthStateChanged(user => {
  if (!user) window.location.href = "login.html";
});

/* Pricing Matrix */
const pricing = {
  "Aerial Square Roof Report": { Standard: 10, Express: 20, Rush: 30 },
  "Residential Roof Report": { Standard: 17, Express: 25, Rush: 30 },
  "Commercial Roof Report": { Standard: 30, Express: 35, Rush: 45 }
};

let currentPrice = 0;
let currentReport = "";
let currentTier = "";

/* Update Pricing UI */
function updatePricing() {
  currentReport = reportType.value;
  currentTier = serviceTier.value;

  if (!currentReport || !currentTier) return;

  currentPrice = pricing[currentReport][currentTier];

  selectedReport.textContent = currentReport;
  selectedTier.textContent = currentTier;
  totalPrice.textContent = `$${currentPrice}`;

  handlePaymentMode();
}

/* Payment Mode Toggle */
function handlePaymentMode() {
  if (!currentReport || !currentTier) return;

  if (PAYMENT_MODE === "simulation") {
    submitOrderBtn.style.display = "block";
    paypalButtonContainer.style.display = "none";
  } else if (PAYMENT_MODE === "live") {
    submitOrderBtn.style.display = "none";
    paypalButtonContainer.style.display = "block";
    renderPayPal();
  }
}

/* Simulation Order Submit */
submitOrderBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!currentReport || !currentTier) {
    orderError.textContent = "Please select report and service tier.";
    return;
  }

  try {
    await db.collection("orders").add({
      userId: user.uid,
      reportType: currentReport,
      serviceTier: currentTier,
      price: currentPrice,
      notes: orderNotes.value,
      status: "pending",
      paymentMode: "simulation",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("✅ Order submitted (simulation)");
    window.location.href = "client_portal.html";

  } catch (err) {
    orderError.textContent = err.message;
  }
});

/* PayPal Live Payment */
function renderPayPal() {
  paypalButtonContainer.innerHTML = "";

  paypal.Buttons({
    createOrder: (data, actions) => {
      return actions.order.create({
        purchase_units: [{
          amount: { value: currentPrice.toString() }
        }]
      });
    },
    onApprove: async (data, actions) => {
      await actions.order.capture();

      await db.collection("orders").add({
        userId: auth.currentUser.uid,
        reportType: currentReport,
        serviceTier: currentTier,
        price: currentPrice,
        notes: orderNotes.value,
        status: "paid",
        paymentMode: "paypal",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("✅ Payment successful!");
      window.location.href = "client_portal.html";
    }
  }).render("#paypalButtonContainer");
}

/* Logout */
function logout() {
  auth.signOut().then(() => window.location.href = "login.html");
}
</script>

</body>
</html>
