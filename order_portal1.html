<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Create Order - Remote Roofers</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa}
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:20px 40px;display:flex;justify-content:space-between;align-items:center}
.btn-back{background:rgba(255,255,255,.2);color:#fff;border:2px solid #fff;padding:8px 20px;border-radius:6px;text-decoration:none;font-weight:600}
.container{max-width:900px;margin:auto;padding:40px 20px}
.order-form{background:#fff;padding:40px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.form-group{margin-bottom:20px}
label{font-weight:600;display:block;margin-bottom:6px}
input,select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px}
.order-summary{background:#f5f7fa;padding:20px;border-radius:8px;margin-top:20px}
.payment-section{margin-top:30px;border-top:2px solid #e0e0e0;padding-top:20px}
.hidden{display:none}
</style>
</head>

<body>
<div class="header">
  <h2>üè† Create New Order</h2>
  <a href="client_portal1.html" class="btn-back">‚Üê Back</a>
</div>

<div class="container">
<div class="order-form">

<div class="form-group">
  <label>Property Address *</label>
  <input id="propertyAddress" required>
</div>

<div class="form-group">
  <label>Report Type *</label>
  <select id="reportType" onchange="updatePricing()" required>
    <option value="">Select</option>
    <option value="Aerial Square Roof Report">Aerial Square Roof Report</option>
    <option value="Residential Roof Report">Residential Roof Report</option>
    <option value="Commercial Roof Report">Commercial Roof Report</option>
  </select>
</div>

<div class="form-group">
  <label>Service Tier *</label>
  <select id="serviceTier" onchange="updatePricing()" required>
    <option value="">Select</option>
    <option value="Standard">Standard (‚â§ 8 hrs)</option>
    <option value="Express">Express (‚â§ 6 hrs)</option>
    <option value="Rush">Rush (2‚Äì3 hrs)</option>
  </select>
</div>

<div class="order-summary">
  <p><strong>Address:</strong> <span id="summaryAddress">-</span></p>
  <p><strong>Report:</strong> <span id="selectedReport">-</span></p>
  <p><strong>Tier:</strong> <span id="selectedTier">-</span></p>
  <p><strong>Total:</strong> <span id="totalPrice">$0</span></p>
</div>

<!-- PAYMENT -->
<div id="paymentSection" class="payment-section hidden">
  <h3>Payment</h3>
  <div id="paypal-button-container"></div>

  <!-- Mock payment (TEST only) -->
  <button id="mockPayBtn" type="button"
    style="display:none;margin-top:15px;padding:12px 20px;
    background:#28a745;color:white;border:none;border-radius:6px;font-weight:600">
    üß™ Mock Pay (Test Mode)
  </button>
</div>

</div>
</div>

<!-- ================= FIREBASE + LOGIC ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= CONFIG ================= */
const APP_MODE = "TEST"; // üîÅ CHANGE TO "LIVE" WHEN READY

const PAYPAL_CLIENT_ID = {
  TEST: "AQiwCgvuiWPWJYtAiSZrPd19lZC0kgGlENQ7Z-1r2xvwkmJS7ovaRIakrE3Yng1fVdqZZKCgR88XGX_D",
  LIVE: "ARiAdLTougjptHbODwbDVmc3ehO6osM9KmmGZLJaVHoSOXCOsjo56lVHx8hi78_HdZq5zkjE4DQSgOLQ"
};

const firebaseConfig = {
  apiKey: "AIzaSyDmBLEUz5EWtv1si_UgfKgOiRS8P-wWOnc",
  authDomain: "remoteroofers-51826.firebaseapp.com",
  projectId: "remoteroofers-51826"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const userId = sessionStorage.getItem("userId");
if (!userId) location.href = "login.html";

/* ================= PRICING ================= */
const pricing = {
  "Aerial Square Roof Report": { Standard:10, Express:20, Rush:30 },
  "Residential Roof Report": { Standard:17, Express:25, Rush:30 },
  "Commercial Roof Report": { Standard:30, Express:35, Rush:45 }
};

let currentPrice = 0;
let paypalRendered = false;

/* ================= UPDATE PRICING ================= */
window.updatePricing = function () {
  if (!reportType.value || !serviceTier.value) return;

  currentPrice = pricing[reportType.value][serviceTier.value];

  summaryAddress.textContent = propertyAddress.value || "-";
  selectedReport.textContent = reportType.value;
  selectedTier.textContent = serviceTier.value;
  totalPrice.textContent = `$${currentPrice}`;

  paymentSection.classList.remove("hidden");

  // üîß FIXES
  paypalRendered = false;
  document.getElementById("paypal-button-container").innerHTML = "";

  if (APP_MODE === "TEST") mockPayBtn.style.display = "inline-block";
  loadPayPal();
};

/* ================= PAYPAL LOADER ================= */
function loadPayPal() {
  if (window.paypal || document.getElementById("paypal-sdk")) {
    return renderPayPal();
  }

  const script = document.createElement("script");
  script.id = "paypal-sdk";
  script.src =
    APP_MODE === "LIVE"
      ? `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID.LIVE}&currency=USD`
      : `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID.TEST}&currency=USD`;

  script.onload = renderPayPal;
  document.body.appendChild(script);
}

/* ================= PAYPAL ================= */
function renderPayPal() {
  if (paypalRendered) return;
  paypalRendered = true;

  paypal.Buttons({
    createOrder: (_, actions) =>
      actions.order.create({
        purchase_units: [{ amount: { value: currentPrice.toFixed(2) } }]
      }),
    onApprove: async (_, actions) => {
      const order = await actions.order.capture();
      await saveOrder(order.id, "paypal");
    }
  }).render("#paypal-button-container");
}

/* ================= MOCK PAYMENT ================= */
mockPayBtn.addEventListener("click", async () => {
  if (APP_MODE !== "TEST") {
    alert("Mock payments are disabled in LIVE mode");
    return;
  }

  if (currentPrice <= 0) {
    alert("Invalid order price");
    return;
  }

  await saveOrder("MOCK-" + Date.now(), "mock");
});


/* ================= SAVE ORDER ================= */
async function saveOrder(paymentId, method) {
  const userSnap = await getDoc(doc(db, "users", userId));
  const user = userSnap.data();

  await addDoc(collection(db, "orders"), {
    userId,
    name: user.name,
    email: user.email,
    address: propertyAddress.value,
    reportType: reportType.value,
    serviceTier: serviceTier.value,
    amount: currentPrice,
    status: "paid",
    paymentMethod: method,
    paypalId: paymentId,
    mode: APP_MODE,
    createdAt: new Date()
  });

  alert("‚úÖ Order Successful");
  location.href = "client_portal1.html";
}
</script>

</body>
</html>
