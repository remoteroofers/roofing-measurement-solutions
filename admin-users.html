<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin | User Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; margin:0; }
    header { background:#222; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    .container { padding:20px; }
    table { width:100%; border-collapse:collapse; background:white; box-shadow:0 5px 15px rgba(0,0,0,.1); }
    th, td { padding:12px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f0f0f0; }
    button { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; }
    .admin-btn { background:#ff3b3b; color:white; }
    .user-btn { background:#0066ff; color:white; }
  </style>
</head>
<body>

<header>
  <h3>Admin â€“ User Management</h3>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Verified</th>
        <th>Role</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const table = document.getElementById("userTable");

// Auth state & admin check
onAuthStateChanged(auth, async (user) => {
  if (!user || !user.emailVerified) {
    window.location.href = "login.html";
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const snapshot = await userRef.get();
  const data = snapshot.data();

  if (!data || data.role.toLowerCase() !== "admin") {
    alert("Admins only");
    window.location.href = "dashboard.html";
    return;
  }

  loadUsersRealTime();
});

// Real-time load all users
function loadUsersRealTime() {
  const usersCol = collection(db, "users");

  onSnapshot(usersCol, (snap) => {
    table.innerHTML = "";
    snap.forEach((docSnap) => {
      const u = docSnap.data();
      const uid = docSnap.id;
      const role = (u.role || "user").toLowerCase();
      const btnClass = role === "admin" ? "admin-btn" : "user-btn";
      const btnText = role === "admin" ? "Demote" : "Make Admin";

      table.innerHTML += `
        <tr>
          <td>${u.email}</td>
          <td>${u.firstName} ${u.lastName}</td>
          <td>${u.phone || ""}</td>
          <td>${u.emailVerified ? "Yes" : "No"}</td>
          <td>${role}</td>
          <td><button class="${btnClass}" onclick="toggleRole('${uid}', '${role}')">${btnText}</button></td>
        </tr>
      `;
    });
  });
}

// Toggle role (admin <-> user)
window.toggleRole = async function(uid, currentRole) {
  const newRole = currentRole === "admin" ? "user" : "admin";
  if (!confirm(`Change role to ${newRole}?`)) return;

  await updateDoc(doc(db, "users", uid), { role: newRole });
};

// Logout
window.logout = async function() {
  await signOut(auth);
  window.location.href = "login.html";
};
</script>

</body>
</html>
